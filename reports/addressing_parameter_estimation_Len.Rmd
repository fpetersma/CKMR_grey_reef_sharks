---
title: "Addressing Len's parameter estimation question"
author: "Felix T Petersma"
date: "2023-03-13"
output:
  html_document:
    df_print: paged
---

Try to fit more parameters than just the abundance related parameters
I believe that this won't work as it is not informative on those parameters,
which would mean that the parameters and not properly defined by the model,
but I am not sure. 

This point was raised by Len in his initial feedback to the first draft of 
shark simulation paper.

For this to run, it is easier not to run the cpp code from the CKMRcpp
package, but instead compile the cpp code here and run as functions. This
way it is easier to modify the functions so that other parameters are 
estimated. 

In this script, we use the complex species.

## Load libraries and data

```{r}
library(pbapply)
library(parallel)
library(Rcpp)
data_folder <- "../data/1_population_multiple_sampling_schemes/"
load(paste0(data_folder, "complex/100_schemes_dfs_suff_unique_combos_sim=555.RData"))

sigma_l <- 2.89             # what is the true measurement error

a0 <- -8.27                # theoretical age at length zero              
k <- 0.0554                 # growth rate
l_inf <- 163                # asymptotic length

n <- 100
```

## Fit the oldskool way, by only estimating abundance in year 0 and growth rate r

```{r, cache=T}
# Rcpp::sourceCpp("oldskool_rcpp.cpp")

n_cores <- 50 # 4 fits per core
cl <- makeCluster(n_cores)
clusterExport(cl = cl,
              list("a0", "l_inf", "sigma_l", "k"),
              envir = environment())
results <- pblapply(dfs_suff[1:n], function(df) {
  ## Create parameter object for nlminb()
  par <- list(
    # sigma_l = log(0.01),
    # phi = boot::logit(1 - 0.153),
    r_f = log(1.000),                             # female growth rate
    r_m = log(1.000),                             # male growth rate
    N_t0_m = log(500),                            # number of reproductive male
    N_t0_f = log(500))                            # number of reproductive females
  
  
  
  ## Take a subset of the data if required
  df_select <- df[, ]
  
  ## Create the data object for nlminb()
  dat <- list(alpha_m = 17,                         # maturity age for males (van=10, ges=17)
              alpha_f = 19,                         # maturity age for females (van=10, ges=19)
              
              # r = log(1.0000),                    # the population growth rate
              sigma_l = log(sigma_l),               # the measurement error on length
              phi = boot::logit(1 - 0.1113),        # phi is the survival rate (van=0.1535, ges=0.1113)
              
              ESTIMATE_R = 2,                       # is r fixed (0), estimated (1), 
              # or sex specific (2)?
              
              max_age = 63,                         # the maximum age to be considered (van=19, ges=63)
              max_length = 200,                     # at least the maximum length in the data
              t0 = 2014,                            # a reference year for the abundance estimation
              vbgf_l_inf = l_inf,                   # asymptotic length for VBGF
              vbgf_k = k,                      # growth coefficient for VBGF
              vbgf_a0 = a0,                         # theoretical age at length 0 for vbgf
              s_i = df_select$indiv_1_sex,
              s_j = df_select$indiv_2_sex,
              c_i = df_select$indiv_1_capture_year,
              c_j = df_select$indiv_2_capture_year,
              a_i = df_select$indiv_1_capture_age,
              a_j = df_select$indiv_2_capture_age,
              l_i = df_select$indiv_1_length,
              l_j = df_select$indiv_2_length,
              kinship = df_select$kinship,
              cov_combo_freq = df_select$covariate_combo_freq,
              n = nrow(df_select))
  
  ## Start the optimisation (make sure the trace and relative tolerance values
  ##                         are correct)
  # system.time({
  Rcpp::sourceCpp("oldskool_rcpp.cpp")
  res <- nlminb(start = par, 
                objective = nllPOPCKMRcppAgeUnknownGestation, 
                dat = dat, 
                control = list(trace = 1, rel.tol = 1e-7))
  # })
  res$dat <- dat
  
  return(res)
}, cl = cl); stopCluster(cl) # end of pblapply() in parallel


```


## Try to also estimate the survival parameter phi

```{r, cache=T, eval=F}
Rcpp::sourceCpp("estimate_phi_rcpp.cpp")

n_cores <- 25 # 4 fits per core
cl <- makeCluster(n_cores)
clusterExport(cl = cl, list("a0", "l_inf", "sigma_l"), envir = environment())
results <- pblapply(dfs_suff[1:n], function(df) {
  ## Create parameter object for nlminb()
  par <- list(
    # sigma_l = log(0.01),
    # phi = boot::logit(1 - 0.153),
    r_f = log(1.000),                             # female growth rate
    r_m = log(1.000),                             # male growth rate
    N_t0_m = log(500),                            # number of reproductive male
    N_t0_f = log(500))                            # number of reproductive females
  
  
  
  ## Take a subset of the data if required
  df_select <- df[, ]
  
  ## Create the data object for nlminb()
  dat <- list(alpha_m = 17,                         # maturity age for males (van=10, ges=17)
              alpha_f = 19,                         # maturity age for females (van=10, ges=19)
              
              # r = log(1.0000),                    # the population growth rate
              sigma_l = log(sigma_l),               # the measurement error on length
              phi = boot::logit(1 - 0.1113),        # phi is the survival rate (van=0.1535, ges=0.1113)
              
              ESTIMATE_R = 2,                       # is r fixed (0), estimated (1), 
              # or sex specific (2)?
              
              max_age = 63,                         # the maximum age to be considered (van=19, ges=63)
              max_length = 200,                     # at least the maximum length in the data
              t0 = 2014,                            # a reference year for the abundance estimation
              vbgf_l_inf = l_inf,                   # asymptotic length for VBGF
              vbgf_k = k,                      # growth coefficient for VBGF
              vbgf_a0 = a0,                         # theoretical age at length 0 for vbgf
              s_i = df_select$indiv_1_sex,
              s_j = df_select$indiv_2_sex,
              c_i = df_select$indiv_1_capture_year,
              c_j = df_select$indiv_2_capture_year,
              a_i = df_select$indiv_1_capture_age,
              a_j = df_select$indiv_2_capture_age,
              l_i = df_select$indiv_1_length,
              l_j = df_select$indiv_2_length,
              kinship = df_select$kinship,
              cov_combo_freq = df_select$covariate_combo_freq,
              n = nrow(df_select))
  
  ## Start the optimisation (make sure the trace and relative tolerance values
  ##                         are correct)
  # system.time({
  res <- nlminb(start = par, 
                objective = nllPOPCKMRcppAgeUnknownGestation, 
                dat = dat, 
                control = list(trace = 1, rel.tol = 1e-7))
  # })
  res$dat <- dat
  
  return(res)
}, cl = cl); stopCluster(cl) # end of pblapply() in parallel


```
## Try to estimate the length measurement paramter sigma_l

## Try to estimate the vbgf parameters